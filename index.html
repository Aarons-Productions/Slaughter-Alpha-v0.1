<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SLAUGHTER</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Permanent Marker', cursive; }
        
        #game-container {
            position: absolute; top: 50%; left: 50%;
            width: 800px; height: 600px; 
            transform: translate(-50%, -50%);
            image-rendering: pixelated;
            background: #87CEEB; border: 4px solid #222;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10;
        }

        .overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: flex-start;
            padding-left: 60px; background: rgba(0,0,0,0.85); z-index: 100;
        }

        .menu-btn { font-size: 3rem; color: #fff; cursor: pointer; margin: 10px 0; border: none; background: none; font-family: inherit; }
        .menu-btn:hover { color: #f00; }

        #hud { 
            position: absolute; bottom: 20px; left: 20px; color: white; 
            font-family: monospace; font-size: 1.5rem; pointer-events: none;
        }
        #stamina-container { width: 200px; height: 10px; background: rgba(255,255,255,0.2); margin-top: 5px; }
        #stamina-bar { width: 100%; height: 100%; background: #f00; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="crosshair"></div>
        <canvas id="c"></canvas>

        <div id="main-menu" class="overlay">
            <h1 style="font-size: 5rem; color: #f00; margin:0;">SLAUGHTER</h1>
            <button class="menu-btn" onclick="startGame()">PLAY</button>
            <button class="menu-btn" onclick="toggleSettings()">SETTINGS</button>
        </div>

        <div id="hud">
            STAMINA
            <div id="stamina-container"><div id="stamina-bar"></div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- CORE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, 4/3, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: false });
        renderer.setSize(800, 600);

        // --- LIGHTING ---
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(10, 50, 10);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));

        // --- WORLD & COLLISION ---
        const colliders = [];
        const targets = [];
        function createBox(x, y, z, w, h, d, color, isTarget = false) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({color}));
            mesh.position.set(x, y + h/2, z);
            scene.add(mesh);
            if(isTarget) targets.push(mesh);
            else colliders.push(new THREE.Box3().setFromObject(mesh));
            return mesh;
        }

        createBox(0, -0.5, 0, 200, 1, 200, 0x2d4c1e); // Grass
        createBox(0, 0, 0, 30, 0.2, 30, 0x444444);    // House Base
        
        // Walls
        createBox(0, 0, -15, 30, 8, 1, 0x5d4037);
        createBox(-15, 0, 0, 1, 8, 30, 0x5d4037);
        createBox(15, 0, 0, 1, 8, 30, 0x5d4037);
        createBox(-10, 0, 15, 10, 8, 1, 0x5d4037);
        createBox(10, 0, 15, 10, 8, 1, 0x5d4037);

        // A Target in the yard
        const targetBot = createBox(0, 0, 40, 1, 2, 1, 0xff0000, true);

        // --- GUN ---
        const gunGroup = new THREE.Group();
        const gunBody = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.6), new THREE.MeshStandardMaterial({color: 0x111111}));
        gunGroup.add(gunBody);
        gunGroup.position.set(0.4, -0.3, -0.5);
        camera.add(gunGroup);
        scene.add(camera);

        // --- SHOOTING SYSTEM ---
        const raycaster = new THREE.Raycaster();
        function shoot() {
            // Kickback animation
            gunGroup.position.z += 0.1;
            setTimeout(() => gunGroup.position.z -= 0.1, 50);

            // Raycast from center of screen
            raycaster.setFromCamera({x: 0, y: 0}, camera);
            const hits = raycaster.intersectObjects(targets);
            if(hits.length > 0) {
                hits[0].object.material.color.set(0xffffff); // Flash white on hit
                setTimeout(() => hits[0].object.material.color.set(0xff0000), 100);
            }
        }

        // --- MOVEMENT & INPUT ---
        let isLocked = false;
        let keys = {};
        let stamina = 100;
        let pitch = 0;
        let yaw = 0;

        window.startGame = () => document.body.requestPointerLock();
        
        document.addEventListener('pointerlockchange', () => {
            isLocked = document.pointerLockElement === document.body;
            document.getElementById('main-menu').style.display = isLocked ? 'none' : 'flex';
        });

        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);
        document.addEventListener('mousedown', () => { if(isLocked) shoot(); });

        document.addEventListener('mousemove', (e) => {
            if(isLocked) {
                yaw -= e.movementX * 0.002;
                pitch -= e.movementY * 0.002;
                pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
                
                camera.rotation.set(pitch, yaw, 0, 'YXZ');
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            if(isLocked) {
                // FIXED STAMINA LOGIC
                const isSprinting = keys['ShiftLeft'] && stamina > 0;
                const moveSpeed = isSprinting ? 0.25 : 0.12;
                
                if (keys['ShiftLeft'] && (keys['KeyW'] || keys['KeyS'] || keys['KeyA'] || keys['KeyD'])) {
                    stamina = Math.max(0, stamina - 0.6); // Clamp at 0
                } else {
                    stamina = Math.min(100, stamina + 0.4); // Clamp at 100
                }
                document.getElementById('stamina-bar').style.width = stamina + "%";

                // MOVEMENT
                const oldPos = camera.position.clone();
                const direction = new THREE.Vector3();
                if(keys['KeyW']) direction.z -= 1;
                if(keys['KeyS']) direction.z += 1;
                if(keys['KeyA']) direction.x -= 1;
                if(keys['KeyD']) direction.x += 1;
                direction.normalize().applyQuaternion(camera.quaternion);
                direction.y = 0; // Keep on ground
                
                camera.position.addScaledVector(direction, moveSpeed);

                // COLLISION
                const pBox = new THREE.Box3().setFromCenterAndSize(camera.position, new THREE.Vector3(1, 2, 1));
                for(let wall of colliders) {
                    if(pBox.intersectsBox(wall)) camera.position.copy(oldPos);
                }

                // SMOOTH BOBBING
                if(direction.length() > 0) {
                    const bob = Math.sin(performance.now() * 0.01) * 0.05;
                    camera.position.y = 1.7 + bob;
                    gunGroup.rotation.z = Math.sin(performance.now() * 0.005) * 0.05;
                } else {
                    camera.position.y = 1.7;
                }
            }
            renderer.render(scene, camera);
        }

        camera.position.set(0, 1.7, 25);
        animate();
    </script>
</body>
</html>